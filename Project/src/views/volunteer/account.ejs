<%- include('../partials/header') %>

<%- include('../partials/navbar-dark') %>

<div class="d-flex am-dark" style="height: 95vh;">

    <%- include('../partials/sidebar-dark') %>

    <div class="content w-100 p-4 ngo-dashboard" style="overflow-y: auto;">
        <div class="w-100 text-white">
            <div class="mb-4">
                <h4>Manage Account</h4>
                <p>Update your profile information and preferences</p>
            </div>
            <div class="row g-4">
                <!-- Left: Personal Information -->
                <div class="col-lg-8">
                    <div class="ngo-section p-4 rounded">
                        <h5 class="text-white mb-4">Personal Information</h5>

                        <!-- Profile Header -->
                        <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <img 
                            src="<%= volunteer.profilePicture ? '/' + volunteer.profilePicture : '/images/default-avatar.png' %>" 
                            class="rounded-circle" width="60" height="60"
                            >
                        </div>
                        <div>
                            <h6 class="mb-0 text-white">
                            <%= volunteer.firstName %> <%= volunteer.lastName %>
                            </h6>
                            <small>Volunteer</small>
                        </div>
                        </div>

                        <!-- Change Photo Button -->
                        <label id="changePhotoBtn" for="profileImage" class="btn btn-primary mb-4 d-none">
                            Change Photo
                        </label>

                        <!-- ✅ FORM (REAL DATA FROM MODELS) -->
                        <form id="profileForm" method="POST" action="/volunteer/profile/update">
                        <div class="row g-3">
                            <input type="file" name="profileImage" id="profileImage" style="display: none;">

                            <!-- Full Name -->
                            <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" name="firstName"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.firstName %>" disabled>
                            </div>

                            <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="lastName"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.lastName %>" disabled>
                            </div>

                            <!-- Email (User Model) -->
                            <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email"
                                class="form-control bg-dark text-white border-0 p-3" data-user-email
                                value="<%= volunteer.userId.email %>" disabled>
                            </div>

                            <!-- Contact (User Model) -->
                            <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text"
                                class="form-control bg-dark text-white border-0 p-3" data-user-contact
                                value="<%= volunteer.userId.contact %>" disabled>
                            </div>

                            <!-- Address -->
                            <div class="col-md-12">
                            <label class="form-label">Address</label>
                            <input type="text" name="address"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.address %>" disabled>
                            </div>

                            <div class="col-md-4">
                            <label class="form-label">City</label>
                            <input type="text" name="city"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.city %>" disabled>
                            </div>

                            <div class="col-md-4">
                            <label class="form-label">State</label>
                            <input type="text" name="state"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.state %>" disabled>
                            </div>

                            <div class="col-md-4">
                            <label class="form-label">Pincode</label>
                            <input type="text" name="pincode"
                                class="form-control bg-dark text-white border-0 p-3"
                                value="<%= volunteer.pincode %>" disabled>
                            </div>

                            <!-- Bio / About -->
                            <div class="col-12">
                            <label class="form-label">Bio</label>
                            <textarea name="about"
                                class="form-control bg-dark text-white border-0 p-3"
                                rows="3" disabled><%= volunteer.about || '' %></textarea>
                            </div>

                        </div>

                        <!-- ✅ Action Buttons -->
                        <div class="mt-4">
                            <button type="button" id="editProfileBtn" class="btn btn-primary">
                            Edit Profile
                            </button>
                            <button type="submit" id="updateProfileBtn" class="btn btn-primary d-none">
                            Update Profile
                            </button>
                        </div>
                        </form>

                    </div>
                </div>
    
                <!-- Right Side -->
                <div class="col-lg-4">
                    <!-- Volunteer Stats -->
                    <div class="ngo-section p-4 rounded mb-4">
                        <h5 class="text-white mb-3">Volunteer Stats</h5>
                        <p class="  mb-2"><i class="bi bi-calendar-event me-2"></i>Member Since: Jan 2022</p>
                        <p class="  mb-2">Total Deliveries: <strong>24</strong></p>
                        <p class="  mb-2">NGOs Joined: <strong>3</strong></p>
                        <!-- <p class="  mb-0">Average Rating: <i class="bi bi-star-fill text-warning"></i>
                            <strong>4.8</strong></p> -->
                    </div>
    
                    <!-- Account Settings -->
                    <div class="ngo-section p-4 rounded">
                        <h5 class="text-white mb-3">Account Settings</h5>
                        <button class="btn btn-dark w-100 mb-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</button>
                        <button class="btn btn-dark w-100 mb-2">Language Preference</button>
                        <!-- <button class="btn btn-dark w-100 mb-2">Notification Settings</button> -->
                        <button class="btn btn-dark w-100 mb-2 d-flex align-items-center">Available
                            <div class="checkbox-apple">
                                <input class="yep" id="availabilityToggler" type="checkbox" <%= volunteer.isAvailable ? "checked" : "" %>>
                                <label for="availabilityToggler"></label>
                            </div>
                        </button>
                        <button class="btn btn-dark w-100 mb-2 d-flex align-items-center">Notifications
                            <div class="checkbox-apple">
                                <input class="yep" id="notificationsToggler" type="checkbox" <%= volunteer.notificationsEnabled ? "checked" : "" %>>
                                <label for="notificationsToggler"></label>
                            </div>
                        </button>
                        <button class="btn btn-danger w-100">Delete Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<%- include('../partials/changePasswordModal') %>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        
        const editBtn = document.getElementById("editProfileBtn");
        const updateBtn = document.getElementById("updateProfileBtn");
        const changePhotoBtn = document.getElementById("changePhotoBtn");
        const profileForm = document.getElementById("profileForm");

        const inputs = document.querySelectorAll(
            "#profileForm input:not([type='file']), #profileForm textarea"
        );

        // ✅ TOGGLE EDIT MODE
        editBtn.addEventListener("click", function () {
            inputs.forEach(input => input.disabled = false);
            editBtn.classList.add("d-none");
            updateBtn.classList.remove("d-none");
            changePhotoBtn.classList.remove("d-none");
        });

        // ✅ VALIDATION FUNCTION
        function validateForm() {
            let isValid = true;
            let message = "";

            const firstName = document.querySelector("input[name='firstName']").value.trim();
            const lastName = document.querySelector("input[name='lastName']").value.trim();
            const address = document.querySelector("input[name='address']").value.trim();
            const city = document.querySelector("input[name='city']").value.trim();
            const state = document.querySelector("input[name='state']").value.trim();
            const pincode = document.querySelector("input[name='pincode']").value.trim();
            const about = document.querySelector("textarea[name='about']").value.trim();
            const email = document.querySelector("input[data-user-email]").value.trim();
            const contact = document.querySelector("input[data-user-contact]").value.trim();

            if (!firstName || !lastName) {
                message = "First name and Last name are required.";
                isValid = false;
            }
            else if (!/^\d{6}$/.test(pincode)) {
                message = "Pincode must be exactly 6 digits.";
                isValid = false;
            }
            else if (!/^\d{10}$/.test(contact)) {
                message = "Contact must be exactly 10 digits.";
                isValid = false;
            }
            else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                message = "Invalid email format.";
                isValid = false;
            }

            if (!isValid) 
                showAlert('danger', message);
            return isValid;
        }

        // ✅ SUBMIT UPDATED PROFILE (PUT REQUEST)
        profileForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            if (!validateForm()) return;

            const formData = new FormData();

            // ✅ FILE (MUST MATCH multer.single('profileImage'))
            const profileImageInput = document.getElementById("profileImage");
            if (profileImageInput && profileImageInput.files.length > 0) {
                formData.append("profileImage", profileImageInput.files[0]);
            }

            // ✅ BUILD volunteerProfile OBJECT (EXACT MATCH)
            const volunteerProfile = {
                firstName: document.querySelector("input[name='firstName']").value.trim(),
                lastName: document.querySelector("input[name='lastName']").value.trim(),
                address: document.querySelector("input[name='address']").value.trim(),
                city: document.querySelector("input[name='city']").value.trim(),
                state: document.querySelector("input[name='state']").value.trim(),
                pincode: document.querySelector("input[name='pincode']").value.trim(),
                about: document.querySelector("textarea[name='about']").value.trim(),
            };

            // ✅ BUILD user OBJECT (EXACT MATCH)
            const user = {
                email: document.querySelector("input[data-user-email]").value.trim(),
                contact: document.querySelector("input[data-user-contact]").value.trim()
            };

            // ✅ MUST MATCH YOUR MIDDLEWARE:
            formData.append("volunteerProfile", JSON.stringify(volunteerProfile));
            formData.append("user", JSON.stringify(user));

            try {
                const res = await fetch("/volunteer/", {
                    method: "PUT",
                    body: formData
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    showAlert('danger', data.message || "Profile update failed");
                    return;
                }

                // ✅ UI RESET ON SUCCESS
                inputs.forEach(input => input.disabled = true);
                updateBtn.classList.add("d-none");
                changePhotoBtn.classList.add("d-none");
                editBtn.classList.remove("d-none");

                showAlert("success", "Profile updated successfully!");

            } catch (err) {
                console.error("Update error:", err);
                showAlert("danger", "Something went wrong while updating profile");
            }
        });


        // Availability Toggle
        const availabilityToggle = document.getElementById('availabilityToggler');
        if (availabilityToggle) {
            availabilityToggle.addEventListener('change', function (event) {
                const isAvailable = event.target.checked;
                fetch(`/volunteer/toggle-availability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ available: isAvailable })
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        showAlert(alertTypes.Success, `Availability ${isAvailable ? 'enabled' : 'disabled'} successfully.`);
                    } else {
                        showAlert(alertTypes.Danger, `Failed to ${isAvailable ? 'enable' : 'disable'} availability. Please try again. ${data.message || ''}`);
                        availabilityToggle.checked = !isAvailable;
                    }
                })
                .catch((err) => {
                    showAlert(alertTypes.Danger, `An error occurred. Please try again.`);
                    console.error('Availability toggle error:', err);
                    availabilityToggle.checked = !isAvailable;
                });
            });
        }

    });
</script>


<%- include('../partials/footer') %>